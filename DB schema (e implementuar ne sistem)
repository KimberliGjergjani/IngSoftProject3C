CREATE TABLE perdoruesi (
    user_id INT PRIMARY KEY AUTO_INCREMENT,
    emri VARCHAR(100) NOT NULL,
    mbiemri VARCHAR(100) NOT NULL,
    email VARCHAR(150) NOT NULL UNIQUE,
    fjalkalimi VARCHAR(255) NOT NULL,
    numri_tel VARCHAR(30) UNIQUE,
    data_regjistrimit TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    roli VARCHAR(50) DEFAULT 'user',
    status VARCHAR(50) DEFAULT 'active'
);

CREATE TABLE user_logs (
    log_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    pershkrim VARCHAR(100),
    ip_adresa VARCHAR(50),
    device VARCHAR(150),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES perdoruesi(user_id) ON DELETE CASCADE
);

CREATE TABLE kompania (
    kompania_id INT PRIMARY KEY AUTO_INCREMENT,
    emri_kompanise VARCHAR(150) NOT NULL,
    email VARCHAR(150) NOT NULL UNIQUE,
    fjalkalimi VARCHAR(255) NOT NULL,
    adresa VARCHAR(255),
    nr_tel VARCHAR(30) UNIQUE,
    data_regjistrimit TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(50) DEFAULT 'active'
);

CREATE TABLE kompania_logs (
    log_id INT PRIMARY KEY AUTO_INCREMENT,
    kompania_id INT NOT NULL,
    pershkrim VARCHAR(100),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (kompania_id) REFERENCES kompania(kompania_id) ON DELETE CASCADE
);

CREATE TABLE autobusi (
    autobusi_id INT PRIMARY KEY AUTO_INCREMENT,
    kompania_id INT NOT NULL,
    marka VARCHAR(100) NOT NULL,
    modeli VARCHAR(100),
    kapaciteti INT NOT NULL,
    viti_prodhimit INT,
    status VARCHAR(50) DEFAULT 'active',
    pergjegjes VARCHAR(100),
    FOREIGN KEY (kompania_id) REFERENCES kompania(kompania_id) ON DELETE CASCADE
);

CREATE TABLE itinerari (
    itinerari_id INT PRIMARY KEY AUTO_INCREMENT,
    autobusi_id INT NOT NULL,
    qyteti_nisjes VARCHAR(100) NOT NULL,
    qyteti_destinacion VARCHAR(100) NOT NULL,
    data_nisjes DATE NOT NULL,
    ora_nisjes TIME NOT NULL,
    numri_vendeve INT NOT NULL,
    status VARCHAR(50) DEFAULT 'active',
    FOREIGN KEY (autobusi_id) REFERENCES autobusi(autobusi_id) ON DELETE CASCADE
);

CREATE TABLE bileta (
    bileta_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    itinerari_id INT NOT NULL,
    data_rezervimit TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    vendi_nr INT NOT NULL,
    UNIQUE(itinerari_id, vendi_nr),
    FOREIGN KEY (user_id) REFERENCES perdoruesi(user_id) ON DELETE CASCADE,
    FOREIGN KEY (itinerari_id) REFERENCES itinerari(itinerari_id) ON DELETE CASCADE
);

CREATE TABLE transaksion (
    transaksion_id INT PRIMARY KEY AUTO_INCREMENT,
    bileta_id INT NOT NULL,
    payer_id INT,
    payer_type VARCHAR(50),
    lloji_transaksionit VARCHAR(50) NOT NULL,
    shuma DECIMAL(10,2) NOT NULL,
    monedha VARCHAR(10) DEFAULT 'EUR',
    data_transaksionit TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    metoda VARCHAR(50) NOT NULL,
    token_transaksioni VARCHAR(255) NOT NULL UNIQUE,
    status VARCHAR(50) DEFAULT 'pending',
    pershkrim VARCHAR(100),
    FOREIGN KEY (bileta_id) REFERENCES bileta(bileta_id) ON DELETE CASCADE
);

CREATE TABLE rating (
    transaksion_id INT PRIMARY KEY,
    vleresim INT CHECK (vleresim BETWEEN 1 AND 5),
    komente VARCHAR(255),
    FOREIGN KEY (transaksion_id) REFERENCES transaksion(transaksion_id) ON DELETE CASCADE
);
